<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Meeting</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.0/peerjs.min.js"></script>
</head>
<body>
  <div class="container">
    <section class="create-meeting">
      <h2>Create Meeting</h2>
      <div class="form-box">
        <label>Meeting ID</label>
        <input type="text" id="meetingID" readonly>

        <label>Password (optional)</label>
        <input type="password" placeholder="Enter password">

        <label>Schedule</label>
        <button class="btn" onclick="window.location.href='schedule.html'">
          Schedule a Meeting
        </button>

        <button class="btn btn-primary" id="save-btn" onclick="saveMeeting()">
          <i class="fas fa-save"></i> Save & Start Meeting
        </button>
      </div>

      <!-- Back button section -->
      <div class="nav-back">
        <button class="btn" onclick="window.location.href='index.html'">‚Üê Back to Home</button>
      </div>
    </section>
  </div>

  <script>
    let peer;
    let meetingID;

    // Initialize PeerJS and generate Meeting ID
    function initializePeerJS() {
      try {
        // Check if PeerJS is loaded
        if (typeof Peer === 'undefined') {
          throw new Error('PeerJS library failed to load');
        }

        // Generate a random peer ID for the meeting
        meetingID = 'meeting_' + Math.random().toString(36).substr(2, 9);
        
        // Initialize PeerJS with the generated ID
        peer = new Peer(meetingID, {
          debug: 0, // Reduced debug level
          config: {
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' }
            ]
          }
        });

        peer.on('open', function(id) {
          console.log('PeerJS connection opened with ID:', id);
          document.getElementById('meetingID').value = id;
        });

        peer.on('error', function(err) {
          console.error('PeerJS error:', err);
          // Fallback to random ID if PeerJS fails
          document.getElementById('meetingID').value = meetingID;
        });

        peer.on('connection', function(conn) {
          console.log('Incoming connection from:', conn.peer);
          // Handle incoming connections (participants joining)
          handleIncomingConnection(conn);
        });

      } catch (error) {
        console.error('Failed to initialize PeerJS:', error);
        fallbackToRandomID();
      }
    }

    function handleIncomingConnection(conn) {
      conn.on('open', function() {
        console.log('Connection established with:', conn.peer);
        
        // Send welcome message
        conn.send({
          type: 'welcome',
          message: 'Welcome to the meeting!',
          host: peer.id
        });
      });

      conn.on('data', function(data) {
        console.log('Received data from participant:', data);
        // Handle incoming data from participants
      });
    }

    function fallbackToRandomID() {
      meetingID = Math.floor(100000 + Math.random() * 900000);
      document.getElementById('meetingID').value = meetingID;
    }

    async function saveMeeting() {
      const saveBtn = document.getElementById('save-btn');
      const originalText = saveBtn.innerHTML;
      
      // Show loading state
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting Meeting...';
      saveBtn.disabled = true;

      try {
        const meetingID = document.getElementById('meetingID').value;
        const password = document.querySelector('input[type="password"]').value;
        
        // Get the actual IP address of the host device
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting IP Address...';
        const hostIP = await getHostIP();
        
        // Store meeting data in localStorage
        const meetingData = {
          hostIP: hostIP,
          meetingID: meetingID,
          username: "Host",
          password: password,
          isHost: true,
          peerId: meetingID
        };

        // Only include peer instance if it exists and is connected
        if (peer && !peer.destroyed) {
          meetingData.peerInstance = true;
        }

        localStorage.setItem('meetingData', JSON.stringify(meetingData));

        // Show success and redirect
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Starting Meeting...';
        setTimeout(() => {
          window.location.href = 'meeting-room.html';
        }, 1000);
        
      } catch (error) {
        console.error('Error creating meeting:', error);
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        alert('Error creating meeting. Please try again.');
      }
    }

    async function getHostIP() {
      try {
        // Method 1: Try to get local IP using WebRTC
        const localIP = await getLocalIP();
        if (localIP) {
          return localIP;
        }
      } catch (error) {
        console.log('Could not get local IP:', error);
      }

      try {
        // Method 2: Get public IP using external service
        const publicIP = await getPublicIP();
        if (publicIP) {
          return publicIP;
        }
      } catch (error) {
        console.log('Could not get public IP:', error);
      }

      // Fallback: Return a placeholder
      return "IP_DETECTION_FAILED";
    }

    async function getLocalIP() {
      return new Promise((resolve) => {
        const pc = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        pc.createDataChannel('');
        
        pc.onicecandidate = (event) => {
          if (event.candidate) {
            const candidate = event.candidate.candidate;
            const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/);
            if (ipMatch) {
              const ip = ipMatch[1];
              // Filter out non-local IPs
              if (ip.startsWith('192.168.') || ip.startsWith('10.') || ip.startsWith('172.')) {
                pc.close();
                resolve(ip);
              }
            }
          }
        };

        pc.createOffer().then(offer => pc.setLocalDescription(offer));
        
        // Timeout after 5 seconds
        setTimeout(() => {
          pc.close();
          resolve(null);
        }, 5000);
      });
    }

    async function getPublicIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        // Fallback to another service
        try {
          const response = await fetch('https://ipapi.co/ip/');
          return await response.text();
        } catch (error2) {
          throw error2;
        }
      }
    }

    // Wait for the page and PeerJS library to load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializePeerJS);
    } else {
      initializePeerJS();
    }

    // Clean up PeerJS connection when leaving the page
    window.addEventListener('beforeunload', function() {
      if (peer && !peer.destroyed) {
        console.log('Destroying PeerJS connection');
        peer.destroy();
      }
    });
  </script>
</body>
</html>